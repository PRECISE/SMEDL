object Poster
    state
        int cur_tracks_out;
        int cur_bytes_in;
        int last_tracks_out;
        int last_bytes_in;
        int cur_time;
        int last_init;
    events
        imported consume_input(int);
        imported produce_tracks(int);
        imported heartbeat(int);
        exported too_few_tracks(int);
    scenarios
        swap_bins:
          Waiting -> heartbeat(now) {
                       last_tracks_out = cur_tracks_out;
                       last_bytes_in = cur_bytes_in;
                       cur_tracks_out = 0;
                       cur_bytes_in = 0;
                       cur_time = now;
                       last_init = 1;
                     }
                  -> Waiting
        check_rate:
          Waiting -> heartbeat(now)
                     when last_init &&
                          track_rate_low(cur_tracks_out, cur_bytes_in,
                                         last_tracks_out, last_tracks_in) {
                        raise too_few_tracks(cur_time);
                     }
                  -> Waiting
        handle_data:
          Waiting -> consume_input(nbytes) {
                       cur_bytes_in = cur_bytes_in + nbytes;
                     }
                  -> Waiting
          Waiting -> produce_tracks(ntracks) {
                       cur_tracks_out = cur_tracks_out + ntracks;
                     }
                  -> Waiting